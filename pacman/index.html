<!DOCTYPE html>
<!-- saved from url=(0040)http://www.flashmonkey.co.uk/lab/pacman/ -->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" class="no-js">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


    <meta name="description" content="A prototype pacman game built using CSS and JavaScript for use across browsers.">
    <title>CSS &amp; JavaScript PACMAN</title>

    <link href="./pacman.css" rel="stylesheet">
    <script src="./keycodes.js"></script>
    <script src="./modernizr.js"></script>

</head>

<body onload="init();">

<!-- SCRIPT IMPORTS -->
<script src="./Animation.js"></script>
<script src="./Ghost.js"></script>
<script src="./KeyButton.js"></script>
<script src="./Level.js"></script>
<script src="./Pip.js"></script>
<script src="./Player.js"></script>

<!-- SCRIPT BODY -->
<script>

    // game vars
    var gameInterval,
        score = 0,
        isPlaying, isKeyDown,
        lastX, lastY,
        isSameColumn, isSameRow,

        // screen/game size vars
        SCREEN_WIDTH = 640,
        SCREEN_HEIGHT = 352,
        CELL_SIZE = 32,
        GRID_WIDTH = SCREEN_WIDTH / CELL_SIZE,
        GRID_HEIGHT = SCREEN_HEIGHT / CELL_SIZE,

        // timestep
        t = 0,
        dt = 10,
        currentTime = (new Date).getTime(),
        accumulator = 0,

        // display surface vars
        canvas = document.createElement("canvas"),
        context = canvas.getContext("2d"),

        // buttons
        leftButton, rightButton, upButton, downButton,

        // input vars
        leftDown, rightDown, upDown, downDown,

        // preload image resources
        assetImages = {};

    var playerImage = assetImages["player"] = new Image();
    assetImages["player"].src = "./player_animated.png";

    var levelImage = assetImages["level"] = new Image();
    assetImages["level"].src = "level_2.png";

    function init() {
        // CANVAS SET UP
        container = document.createElement("div");
        container.id = "container";
        container.style.width = SCREEN_WIDTH + "px";
        container.style.height = SCREEN_HEIGHT + "px";
        document.body.appendChild(container);
        container.appendChild(canvas);
        canvas.width = SCREEN_WIDTH;
        canvas.height = SCREEN_HEIGHT;

        // EVENT LISTENERS
        document.addEventListener("keydown", onKeyPress, false);
        document.addEventListener("keyup", onKeyPress, false);
        container.addEventListener("click", onClicked, false);

        // level
        level = new Level(levelImage, context);

        charcontainer = document.createElement("div");
        charcontainer.className = "charcontainer";
        charcontainer.style.width = SCREEN_WIDTH + "px";
        charcontainer.style.height = SCREEN_HEIGHT + "px";
        container.appendChild(charcontainer);

        // player character
        player = new Player(CELL_SIZE, CELL_SIZE, playerImage);
        charcontainer.appendChild(player.domElement);

        // ghost
        ghosts = []

        infobg = document.createElement('div');
        infobg.id = "infobg";
        infobg.className = "info";
        infobg.style.width = SCREEN_WIDTH + 'px';
        infobg.style.height = SCREEN_HEIGHT + 'px';
        container.appendChild(infobg);
        info = document.createElement('div');
        info.id = "info";
        info.className = "info";
        info.style.width = '100%';
        container.appendChild(info);

        scoreContainer = document.createElement('div');
        scoreContainer.id = "score";
        scoreContainer.style.width = SCREEN_WIDTH + 'px';
        document.body.appendChild(scoreContainer);

        ghostContainer = document.createElement('div');
        ghostContainer.id = "ghostContainer";
        document.body.appendChild(ghostContainer);

        for(var i = 1; i <= 5; i ++){
            var cropContainer = document.createElement('div');
            cropContainer.className = "crop-container"

            var ghostImage = new Image();
            ghostImage.src = "./ghost" + i +".png";
            ghostImage.id = "ghost" + i;

            cropContainer.appendChild(ghostImage)
            ghostContainer.appendChild(cropContainer)
            cropContainer.addEventListener("click", function(evt){
               addGhost(evt.target);
            });
        }


        player.init();

        showInfo("<p> CLICK TO START</p>");
    }

    function addGhost(img){
        fetch("/api/addGhost?ghost=" + img.id)
            .then(function(response){
                if(response.status === 200){
                    var ghost = new Ghost(CELL_SIZE * 11, CELL_SIZE * 5, img);
                    ghosts.push(ghost)
                    charcontainer.appendChild(ghost.domElement);
                    ghost.init();
                    enableBadge("addGhostBadge");
                }else{
                    showInfo("<h1 class='flippedSadFace'>:(</h1> ADDING A GHOST IS NOT SUPPORTED ON THE GAME SERVER.")
                }
            }).catch(function(){
            console.log(ex)
            showInfo("<h1 class='flippedSadFace'>:(</h1> <p>IS YOUR GAME SERVER RUNNING?? COULD NOT ADD A GHOST</p>");
        });
    }

    function run() {
        var newTime = (new Date).getTime();
        var deltaTime = (newTime - currentTime);
        currentTime = newTime;

        if (deltaTime > 25) {
            deltaTime = 25;
        }

        accumulator += deltaTime;

        while (accumulator >= dt) {
            accumulator -= dt;
            update();
        }
        render();
    }

    function update() {

        player.update();
        fetch("/api/trackPacman?x=" + player.xp + "&y=" + player.yp)
            .then(function (response) {
                if (response.status !== 200) {
                    showInfo("<h1 class='flippedSadFace'>:(</h1> <p>TRACKING PACMANS MOVEMENTS NOT IMPLEMENTED</p>");
                } else {
                    console.log(">>> UPDATE <<<")
                    if (player.xp % CELL_SIZE == 0 && player.yp % CELL_SIZE == 0) {
                        var cx = player.row = player.xp / CELL_SIZE;
                        var cy = player.column = player.yp / CELL_SIZE;

                        if (upDown && player.dirY > -1 && level.cellData[cx][cy - 1] != 0) player.moveUp();
                        else if (downDown && player.dirY < 1 && level.cellData[cx][cy + 1] != 0) player.moveDown();
                        else if (leftDown && player.dirX > -1 && level.cellData[cx - 1][cy] != 0) player.moveLeft();
                        else if (rightDown && player.dirX < 1 && level.cellData[cx + 1][cy] != 0) player.moveRight();
                        else if (player.dirX == 1 && level.cellData[cx + 1][cy] == 0) player.stopMovement();
                        else if (player.dirX == -1 && level.cellData[cx - 1][cy] == 0) player.stopMovement();
                        else if (player.dirY == 1 && level.cellData[cx][cy + 1] == 0) player.stopMovement();
                        else if (player.dirY == -1 && level.cellData[cx][cy - 1] == 0) player.stopMovement();

                        if (level.cellData[cx][cy] == 1) {
                            level.pips[cx][cy].munch();
                            level.cellData[cx][cy] = 2;
                            ++score;
                            document.getElementById("score").innerHTML = "SCORE: " + score;
                            if (score == level.totalPips) {
                                onGameOver(true);
                            }
                        }
                    }
                    else {
                        if (upDown && player.dirY != -1 && player.dirX == 0) player.moveUp();
                        else if (downDown && player.dirY != 1 && player.dirX == 0) player.moveDown();
                        else if (leftDown && player.dirX != -1 && player.dirY == 0) player.moveLeft();
                        else if (rightDown && player.dirX != 1 && player.dirY == 0) player.moveRight();
                    }
                    enableBadge("trackPacmanBadge");
                }
            }).catch(function (ex) {
            console.log(ex)
            showInfo("<h1 class='flippedSadFace'>:(</h1> <p>IS YOUR GAME SERVER RUNNING?? COULD NOT TRACK PACMANS MOVEMENTS</p>");
        });
    }

    function render() {
        player.render();

        for (let ghost of ghosts) {
            ghost.render();
        }
    }

    function updateGhost() {
        var playerCellX = player.row;
        var playerCellY = player.column;

        var playerChangedPos = (playerCellX != lastX || playerCellY != lastY);
        lastX = playerCellX;
        lastY = playerCellY;

        debugger;

        for (let ghost of ghosts) {
            var lastRow = ghost.row;
            var lastColumn = ghost.column;

            var cx = ghost.row = ghost.xp / CELL_SIZE;
            var cy = ghost.column = ghost.yp / CELL_SIZE;

            if (!ghost.chasing && (ghost.dirX != 0 || ghost.dirY != 0)) {
                var nextTileFree = false;

                if (ghost.dirY <= -1 && level.cellData[cx][cy - 1] != 0) nextTileFree = true;
                else if (ghost.dirY >= 1 && level.cellData[cx][cy + 1] != 0) nextTileFree = true;
                else if (ghost.dirX <= -1 && level.cellData[cx - 1][cy] != 0) nextTileFree = true;
                else if (ghost.dirX >= 1 && level.cellData[cx + 1][cy] != 0) nextTileFree = true;

                if (nextTileFree) return;
            }

            var nodes = [];

            if (level.cellData[cx + 1][cy] != 0) nodes.push([cx + 1, cy, 1, 0]);
            if (level.cellData[cx - 1][cy] != 0) nodes.push([cx - 1, cy, -1, 0]);
            if (level.cellData[cx][cy + 1] != 0) nodes.push([cx, cy + 1, 0, 1]);
            if (level.cellData[cx][cy - 1] != 0) nodes.push([cx, cy - 1, 0, -1]);

            if (nodes.length == 1) {
                ghost.dirX = nodes[0][2];
                ghost.dirY = nodes[0][3];
            }
            else if (!ghost.chasing) {
                var node = nodes[Math.floor(Math.random() * nodes.length)];
                ghost.dirX = node[2];
                ghost.dirY = node[3];
            }
            else {
                var smallest = Infinity;
                var node;

                var i = nodes.length;
                while (--i > -1) {
                    var dx = Math.abs(playerCellX - nodes[i][0]);
                    var dy = Math.abs(playerCellY - nodes[i][1]);
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < smallest && ((nodes[i][0] != lastRow && nodes[i][1] != lastColumn) || playerChangedPos)) {
                        smallest = dist;
                        node = nodes[i];
                    }
                }

                if (node) {
                    ghost.dirX = node[2];
                    ghost.dirY = node[3];
                }
            }
        }
    }

    function onGameOver(complete) {
        stopGame();

        var str;
        if (complete) {
            str = "<h1>YOU WIN!</h1><p> CLICK TO PLAY AGAIN</p>";
        }
        else {
            str = "<h1>GAME<br>OVER</h1><p> CLICK TO RESTART</p>";
        }

        showInfo(str);
        container.addEventListener('click', onClicked, false);
        container.style.cursor = "pointer";
    }

    function resetGame() {
        score = 0;
        level.reset();
        player.reset();
        for (let ghost of ghosts) {
            ghost.reset();
        }
    }

    function showInfo(str) {
        if (str) {
            document.getElementById("info").innerHTML = str;
            info.style.top = (SCREEN_HEIGHT - info.offsetHeight) * 0.5 + "px";
        }

        info.style.opacity = 1;
        infobg.style.opacity = 0.55;
    }

    function onClicked(e) {
        container.removeEventListener('click', onClicked, false);
        container.style.cursor = "default";

        startGame();
    }

    function onKeyPress(e) {
        if (!isPlaying && !isKeyDown) onClicked();
        isKeyDown = (e.type == "keydown");

        switch (e.keyCode) {
            case KEY_LEFT :
            case leftButton :
                leftDown = isKeyDown;
                break;

            case KEY_RIGHT :
            case rightButton :
                rightDown = isKeyDown;
                break;

            case KEY_UP :
            case upButton :
                upDown = isKeyDown;
                break;

            case KEY_DOWN :
            case downButton :
                downDown = isKeyDown;
                break;
        }
    }

    function startGame() {
        fetch("/api/startGame")
            .then(function (response) {
                if (response.status === 200) {
                    if (isPlaying) return;
                    isPlaying = true;
                    document.getElementById("score").innerHTML = "SCORE: " + score;
                    resetGame();
                    enableBadge("startGameBadge")
                    gameInterval = setInterval(run, 1);
                    info.style.opacity = 0;
                    infobg.style.opacity = 0;
                } else {
                    showInfo("<h1 class='flippedSadFace'>:(</h1> <p>START GAME NOT IMPLEMENTED IN GO YET</p>")
                }
            })
            .catch(function (ex) {
                showInfo("<h1 class='flippedSadFace'>:(</h1> <p>START GAME SERVER CALL FAILED. IS YOUR GO SERVER RUNNING??</p>")
            });
    }

    function enableBadge(badgeId) {
        var element = document.getElementById(badgeId)
        element.classList.remove("disabledBadge");
    }

    function stopGame() {
        isPlaying = false;
        clearInterval(gameInterval);
    }
</script>

<style>
    .disabledBadge .numberCircle {
        opacity: 0.3;
    }

    .badges {
        margin: 0 auto;
        width: 960px;
    }

    .badgeContainer {
        float: left;
        padding: 20px;
    }

    .numberCircle {
        margin: 0 auto;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        padding: 8px;
        background: #fff;
        border: 2px solid #666;
        color: #666;
        text-align: center;
        font: 32px Arial, sans-serif;
        margin-bottom: 5px;
    }

    .flippedSadFace {
        transform: rotate(90deg);
    }
    .crop-container{
        width:32px;
        overflow:hidden;
        float:left;
        margin:5px;
    }
    #ghostContainer{
        cursor: pointer;
        width:210px;
        margin:0 auto;
        padding: 0px;
        position: relative;
        margin-top: 5px;
        text-align: center;
    }
</style>

<div class="badges">
    <div id="startGameBadge" class="disabledBadge badgeContainer">
        <div class="numberCircle">1</div>
        Start the Game
    </div>
    <div id="trackPacmanBadge" class="disabledBadge badgeContainer">
        <div class="numberCircle" style="background:dodgerblue;color:white;">2</div>
        Track pacman movements
    </div>
    <div id="addGhostBadge" class="disabledBadge badgeContainer">
        <div class="numberCircle" style="background:red;color:white;">3</div>
        Add one ghost
    </div>
    <div id="moveGhostBadge" class="disabledBadge badgeContainer">
        <div class="numberCircle" style="background:orange;color:white;">4</div>
        Randomly move ghost
    </div>
    <div id="gameOverBadge" class="disabledBadge badgeContainer">
        <div class="numberCircle" style="background:limegreen;color:white;">5</div>
        Determine if pacman was caught
    </div>
    <div id="moreGhostsBadge" class="disabledBadge badgeContainer">
        <div class="numberCircle" style="background:darkcyan;color:white;">6</div>
        Add more ghosts
    </div>
</div>
<div style="clear:both;"></div>
</body>
</html>
